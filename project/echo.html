<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Media Player</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <style>audio{margin-right:auto;margin-left:auto;width:100%}.fixed-top{background-color:#FFF}.table-hover tbody tr:hover td, .table-hover tbody tr:hover th{color:green;font-weight: bold;}.h{display:none}</style>
    <!-- <style>table{margin-top:50px;}</style> -->
</head>
  <body>

    <div class="fixed-top mt-3 px-3 py-1">
        <audio id="ap" controls class="media-document audio iPhone"></audio>
        <video id="vp" controls></video>
        <!-- <video id="vp" width="320" height="176" controls></video> -->
    </div>

    <div style='margin-top:60px'>
    <div class="input-group px-3 py-1">
        <input id="delaySec" type="number" value="0" class="form-control">
        <button class="btn btn-outline-secondary" type="button" onclick="delayTime()">Delay</button>
    </div>
    </div>

    <div class="p-3">
        <table class="table table-hover">
            <tbody id="lrc">

            </tbody>
        </table>
    </div>

<script
  src="https://code.jquery.com/jquery-3.7.1.slim.min.js"
  integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8="
  crossorigin="anonymous">
</script>

<script>

$("#vp").hide();

function timeMark(sec){
    let mm=Math.floor(sec/60);
    let ss=Math.floor((sec-mm*60));
    ss=ss.toFixed(0);
    return [("0"+mm).slice(-2),("0"+ss).slice(-2)].join(':');
}


let delaySec=Number($('#delaySec').val());
getData();
  
async function getData(){
    let response=await fetch('https://evenbeiter.github.io/project/list.json');
    let str=await response.text();
    let data=JSON.parse(str);
    
    let url=window.location.href;
    //let url='https://evenbeiter.github.io/project/echo.html?id=1';
    let i=Number(url.slice(-url.length+url.indexOf('=')+1));
    let filename=data[i][0];
    let name=filename.replace('_',':');
    document.querySelector('title').textContent=name;
    let mediaSrc=data[i][1];
    $('#ap').attr('src',mediaSrc);

    let lrcSrc='https://evenbeiter.github.io/project/src/'+filename+'.txt';
    $('#delaySec').val(Number(data[i][2]));
    delaySec=Number($('#delaySec').val())
    getLrc(lrcSrc);
}

async function getLrc(url){
    let response = await fetch(url);
    let str = await response.text();
    putlrc(str);
}

function delayTime(){
    delaySec=Number($('#delaySec').val());
    let title=document.querySelector('title').textContent;
    let lrcSrc='https://evenbeiter.github.io/project/src/'+title.replace(':','_')+'.txt';
    getLrc(lrcSrc);
}

function putlrc(d) {
    var c = d.split("\r\n");
    loadLrc2Page(c);
}

function loadLrc2Page(l) {
    var d, e, h = [],
        k = "";
    var j = 0;

    for (var f = 0; f < l.length; f++) {
        if (l[f].trim() == "") {    //f=length of lrc
            continue;
        }
        if (/\[\d\d:\d\d\.\d\d\]/.test(l[f])) {
            var g = l[f].indexOf("]");
            d = l[f].substr(1, g - 1);
            e = l[f].substr(g + 1);
            var c = s2n(d); //d=time; e=text; c=seconds; h=array of start time
            h.push(parseFloat(c));
            k += '<tr><td>' + (++j) + '</td><td class="h">' + c +'</td><td>' + e + '</td></tr>';
            
        }
    }

    $("#lrc").html(k);

}


function s2n(a) {
    n = a.split(":");
    // n = parseInt(n[0]) * 60 + parseFloat(n[1]);
    n = parseInt(n[0]) * 60 + parseFloat(n[1])+delaySec;
    return n.toFixed(2);
}


$(function(){
    $(document).on("click", "table tbody tr", function(e) {

        let startTime=Number($(this).children(':nth-child(2)').text());
        let endTime=Number($(this).next().children(':nth-child(2)').text());

        startPlay(startTime,endTime);

        async function startPlay(startTime,endTime){

            let audio=$("#ap")[0];
            let dr = audio.duration;

            while (isNaN(dr)||dr===Infinity){
            await new Promise(resolve=> setTimeout(resolve,200));
            }
            audio.currentTime=startTime;
            audio.play();

            setTimeout(()=>{
                audio.pause();
                audio.currentTime=startTime;
            }, (endTime-startTime+0.1)*1000);
        }

    });
});



</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js" integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V" crossorigin="anonymous"></script>
</body>
</html>
