<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Morningstar</title>

    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- jquery UI & mousewheel -->
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
        integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-mousewheel/3.1.13/jquery.mousewheel.min.js"></script>
    <!-- bootstrap stylesheet -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <!-- jquery UI stylesheet -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">

    <!-- HTML Codes by Quackit.com -->

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        table.table.table-striped tr:hover td {
            background-color: #d4e3f2;
        }

        th,
        td {
            white-space: nowrap;
            line-height: 9px;
            min-height: 9px;
            height: 9px;
        }


        /* css to freeze pane */
        .tab-pane {
            overflow: auto;
            width: 100%;
            height: 80vh;
        }

        th {
            background-color: white;
        }

        table {
            table-layout: auto;
            width: 100%;
        }

        td:first-child,
        th:first-child {
            position: sticky;
            left: 0;
            z-index: 1;
        }

        thead tr th {
            position: sticky;
            top: 0;
        }

        th:first-child {
            z-index: 2
        }

        .tr-ind {
            color: firebrick;
        }

        .tr-twn {
            color: blue;
        }

        table.table.table-striped td.td-nbf {
            background-color: #d4e3f2;
        }

        table.table td.td-non-nbf {
            background-color: white;
        }

        .table-striped tr:nth-child(odd) td {
            background-color: #f9f9f9;
        }

        .clear-both {
            clear: both;
        }

        .inputfield {
            height: 25px;
        }

        .w-ticker {
            width: 200px;
        }

        .w-ccy {
            width: 50px;
        }

        .w-name {
            width: 350px;
        }

        .w-tr {
            width: 60px;
        }

        .input-numbers {
            font-size: 12px;
            text-align: right;
        }

        .input-text {
            font-size: 12px;
        }

        /* for chart overlay */
        .black_overlay {
            display: none;
            position: absolute;
            top: 0%;
            left: 0%;
            width: 100%;
            height: 100%;
            background-color: black;
            z-index: 1001;
            -moz-opacity: 0.6;
            opacity: .60;
            filter: alpha(opacity=66);
        }

        .white_content {
            display: none;
            position: absolute;
            top: 5vh;
            /* left: 5%; */
            width: 100%;
            height: 90vh;
            padding: 3px;
            border: 1px solid gray;
            background-color: white;
            z-index: 1002;
            overflow: auto;
        }
    </style>


</head>


<body>

    <div class="d-flex justify-content-center">
        <div class="spinner-border" role="status" id="spinner">
          <span class="sr-only">Loading...</span>
        </div>
    </div>

    <!-- /************************************/
        // for PLOTLY CHART
        /************************************/ -->

    <div id="light" class="white_content">
        <p style='text-align: right'><a href="javascript:void(0)" onclick="closeChart()">CLOSE</a>
        </p>

        <!-- PLOTLY CHART STARTS -->

        <!-- from/to dates input fields -->
        <div class="input-group input-group-sm mb-3" style="width: 150px; float: left; margin-right: 5px">
            <div class="input-group-prepend">
                <span class="input-group-text" id="inputGroup-sizing-sm">From</span>
            </div>
            <input id="startDate" type="text" class="form-control" aria-label="startDate"
                aria-describedby="inputGroup-sizing-sm">
        </div>

        <div class="input-group input-group-sm mb-3" style="width: 150px; float: left; margin-right: 5px">
            <div class="input-group-prepend">
                <span class="input-group-text" id="inputGroup-sizing-sm">To</span>
            </div>
            <input id="endDate" type="text" class="form-control" aria-label="endDate"
                aria-describedby="inputGroup-sizing-sm">
        </div>

        <button class="btn btn-light btn-sm" onclick="makePlotly()">Chart</button>
        <button class="btn btn-light btn-sm" onclick="clearAll()">Clear All</button>

        <!-- ticker, currency, name and return input fields -->
        <div class="clear-both">
            <div class="w-ticker float-left"><input id="ticker01" type="text" class="form-control inputfield input-text"
                    aria-label="ticker01" aria-describedby="inputGroup-sizing-sm"></div>
            <div class="w-ccy float-left"><input id="ccy01" type="text" class="form-control inputfield input-text"
                    aria-label="ccy01" aria-describedby="inputGroup-sizing-sm"></div>
            <div class="w-name float-left"><input id="name01" type="text" class="form-control inputfield input-text"
                    aria-label="name01" aria-describedby="inputGroup-sizing-sm"></div>
            <div class="w-tr float-left"><input id="tr01" type="text" class="form-control inputfield input-numbers"
                    aria-label="tr01" aria-describedby="inputGroup-sizing-sm"></div>
        </div>

        <div class="clear-both">
            <div class="w-ticker float-left"><input id="ticker02" type="text" class="form-control inputfield input-text"
                    aria-label="ticker02" aria-describedby="inputGroup-sizing-sm"></div>
            <div class="w-ccy float-left"><input id="ccy02" type="text" class="form-control inputfield input-text"
                    aria-label="ccy02" aria-describedby="inputGroup-sizing-sm"></div>
            <div class="w-name float-left"><input id="name02" type="text" class="form-control inputfield input-text"
                    aria-label="name02" aria-describedby="inputGroup-sizing-sm"></div>
            <div class="w-tr float-left"><input id="tr02" type="text" class="form-control inputfield input-numbers"
                    aria-label="tr02" aria-describedby="inputGroup-sizing-sm"></div>
        </div>

        <div class="clear-both">
            <div class="w-ticker float-left"><input id="ticker03" type="text" class="form-control inputfield input-text"
                    aria-label="ticker03" aria-describedby="inputGroup-sizing-sm"></div>
            <div class="w-ccy float-left"><input id="ccy03" type="text" class="form-control inputfield input-text"
                    aria-label="ccy03" aria-describedby="inputGroup-sizing-sm"></div>
            <div class="w-name float-left"><input id="name03" type="text" class="form-control inputfield input-text"
                    aria-label="name03" aria-describedby="inputGroup-sizing-sm"></div>
            <div class="w-tr float-left"><input id="tr03" type="text" class="form-control inputfield input-numbers"
                    aria-label="tr03" aria-describedby="inputGroup-sizing-sm"></div>
        </div>

        <div class="clear-both">
            <div class="w-ticker float-left"><input id="ticker04" type="text" class="form-control inputfield input-text"
                    aria-label="ticker04" aria-describedby="inputGroup-sizing-sm"></div>
            <div class="w-ccy float-left"><input id="ccy04" type="text" class="form-control inputfield input-text"
                    aria-label="ccy04" aria-describedby="inputGroup-sizing-sm"></div>
            <div class="w-name float-left"><input id="name04" type="text" class="form-control inputfield input-text"
                    aria-label="name04" aria-describedby="inputGroup-sizing-sm"></div>
            <div class="w-tr float-left"><input id="tr04" type="text" class="form-control inputfield input-numbers"
                    aria-label="tr04" aria-describedby="inputGroup-sizing-sm"></div>
        </div>


        <!-- charting area -->
        <div id="comp" class="clear-both" style="height: 75%"></div>


        <!-- PLOTLY CHART ENDS -->

    </div>
    <div id="fade" class="black_overlay"></div>



    <!-- /************************************/
            // for PERFORMANCE TABLE
            /************************************/ -->

    <br>

    <!-- bootstrap nav tabs START -->
    <nav>
        <div class="nav nav-tabs" id="nav-tab" role="tablist"></div>
    </nav>

    <div class="tab-content" id="nav-tabContent"></div>
    <!-- bootstrap nav tabs END -->

    <br>
    <div class="input-group input-group-sm mb-3" style="width: 150px; float: left; margin-right: 5px">
        <div class="input-group-prepend">
            <span class="input-group-text" id="inputGroup-sizing-sm">Currency</span>
        </div>
        <input id="ccy" type="text" class="form-control" aria-label="currency" aria-describedby="inputGroup-sizing-sm">
    </div>
    <button class="btn btn-light btn-sm" onclick="getChart()">m*Chart</button>
    <button class="btn btn-light btn-sm" onclick="plotlyChart()">Chart</button>

    <button class="btn btn-light btn-sm" style="width: 100px" onclick="clearAll()">Clear All</button>
    <button class="btn btn-light btn-sm" onclick="refresh()">Refresh</button>

    </div>


    <script>


        $(document).ready(async function () {
            await createPage('mac');
            await createPage('hyb');
            await createPage('ghy');
            await createPage('ig');
            await createPage('si');
            await createPage('emdlc');
            await createPage('emdhc');
            await createPage('cb');
            await createPage('eme');
            await createPage('ge');
            await createPage('use');
            await createPage('fivg');
            await createPage('reit');
            await createPage('ar');

            await createPage('site');
            await createPage('ucits');
            await createPage('project');

            getSearchTab();
            hideSpinner();
        })




        /************************************/
        // get search results
        /************************************/


        function getSearchResults() {

            var sec = document.getElementById("search-value").value;

            document.getElementById("search-table").innerHTML = "";
            // get json url
            // lwbti4ryk4
            jsonUrl_url = "https://lt.morningstar.com/api/rest.svc/klr5zyak8x/security/screener?page=1&pageSize=500&outputType=json&version=1&languageId=zh-Hant&locale=zh-Hant";
            jsonUrl_uni = "&universeIds=FOTWN$$ALL|FOIRL$$ALL|FOLUX$$ALL|ETALL$$ALL|IXALL$$ALL";
            jsonUrl_data = "&securityDataPoints=SecId|PerformanceId|ISIN|Ticker|Name|LegalName|CategoryId|CategoryName|PriceCurrency|ClosePrice|GBRReturnD1|GBRReturnW1|GBRReturnM1|GBRReturnM3|GBRReturnM6|GBRReturnM0|GBRReturnM12|GBRReturnM36|GBRReturnM60|GBRReturnM120|MaxFrontEndLoad|FundTNAV|StandardDeviationM12|StandardDeviationM36|SharpeM36|ClosePriceDate|InceptionDate|investmenttype|BrandingCompanyId";
            jsonUrl_dataAll = "&securityDataPoints=ISIN|SecId|PerformanceId|Name|LegalName|PriceCurrency|CategoryName|ClosePrice|StarRatingM255|SustainabilityRank|QuantitativeRating|AnalystRatingScale|Yield_M12|GBRReturnD1|GBRReturnW1|GBRReturnM1|GBRReturnM3|GBRReturnM6|GBRReturnM0|GBRReturnM12|GBRReturnM36|GBRReturnM60|GBRReturnM120|MaxFrontEndLoad|OngoingCharge|OngoingCostActual|PerformanceFeeActual|TransactionFeeActual|MaximumExitCostAcquired|FeeLevel|ManagerTenure|MaxDeferredLoad|InitialPurchase|FundTNAV|EquityStyleBox|BondStyleBox|AverageMarketCapital|AverageCreditQualityCode|EffectiveDuration|MorningstarRiskM255|AlphaM36|BetaM36|R2M36|StandardDeviationM36|SharpeM36|InvestorTypeRetail|InvestorTypeProfessional|InvestorTypeEligibleCounterparty|ExpertiseBasic|ExpertiseAdvanced|ExpertiseInformed|ReturnProfilePreservation|ReturnProfileGrowth|ReturnProfileIncome|ReturnProfileHedging|ReturnProfileOther|TrackRecordExtension";
            jsonUrl_pfId = "&term=" + sec;

            mstarFile = jsonUrl_url + jsonUrl_uni + jsonUrl_data + jsonUrl_pfId;

            $.getJSON(mstarFile, function (mstar_data) {

                // append thead
                let thead = `
                                <thead>
                                    <tr>
                                        <th>ISIN</th>
                                        <th>SecId</th>
                                        <th>PerformanceId</th>
                                        <th>Ticker</th>
                                        <th>Name</th>
                                        <th>Currency</th>
                                        <th>AUM</th>
                                    </tr>
                                </thead>
                                `;

                $('#search-table').append(thead);

                // append tbody
                $('#search-table').append('<tbody>');

                let rows_data = mstar_data["rows"];


                rows_data.forEach(function (data) {


                    var dec = 1; //define number of decimals

                    var sec_data = '';
                    sec_data += '<tr>';
                    sec_data += '<td>' + data.ISIN + '</td>'
                    sec_data += '<td>' + data.SecId + '</td>'
                    sec_data += '<td>' + data.PerformanceId + '</td>'
                    sec_data += '<td>' + data.Ticker + '</td>'
                    sec_data += '<td>' + data.Name + '</td>'
                    sec_data += '<td>' + data.PriceCurrency + '</td>'
                    sec_data += '<td class="text-right">' + formatNumber(parseFloat(data.FundTNAV).toFixed(0)) + '</td>'

                    sec_data += '</tr>';

                    $('#search-table').append(sec_data);

                })

                $('#search-table').append('</tbody>');

            });

        }


        function getSearchTab(){
            // append nav-search-tab
            let navTab = `
                <a class="nav-item nav-link" id="nav-search-tab" data-toggle="tab" href="#nav-search" role="tab" 
                aria-controls="nav-search" aria-selected="false">Search</a>
            `;
            $('#nav-tab').append(navTab);

            let navTabContent = `
                <div class="tab-pane fade" id="nav-search" role="tabpanel" aria-labelledby="nav-search-tab">
                <br>
                <div class="input-group input-group-sm mb-3" style="width: 300px; float: left; margin-right: 5px">
                    <input id="search-value" type="text" class="form-control" aria-label="Currency"
                        aria-describedby="inputGroup-sizing-sm">
                </div>
                <button class="btn btn-light btn-sm" onclick="getSearchResults()">Search</button><br>
                <br>
                <table class="table table-sm table-bordered table-striped" id="search-table" style="font-size: 11px">
                </table>
                </div>
            `;
            $('#nav-tabContent').append(navTabContent);

        }


        /************************************/
        // get performance table
        /************************************/


        function createPage(tabName) {
            createTab(tabName);
            getTable(tabName);
        }


        function createTab(tabName){
            // append nav tab & tab content
            var navTab = "";
            var navTabContent = "";

            if (tabName == 'mac'){
                navTab = '<a class="nav-item nav-link active" id="nav-' + tabName + '-tab" data-toggle="tab" href="#nav-' + tabName 
                                + '" role="tab" aria-controls="nav-' + tabName + '" aria-selected="true">' + tabName.toUpperCase() + '</a>';                
                navTabContent = '<div class="tab-pane fade show active" id="nav-' + tabName + '" role="tabpanel" aria-labelledby="nav-' 
                                + tabName + '-tab"><table class="table table-sm table-bordered table-striped" id="' + tabName 
                                + '-table" style="font-size: 11px"></table></div>';                           
            } else {
                navTab = '<a class="nav-item nav-link" id="nav-' + tabName + '-tab" data-toggle="tab" href="#nav-' + tabName 
                                + '" role="tab" aria-controls="nav-' + tabName + '" aria-selected="true">' + tabName.toUpperCase() + '</a>';                
                navTabContent = '<div class="tab-pane fade" id="nav-' + tabName + '" role="tabpanel" aria-labelledby="nav-' 
                                + tabName + '-tab"><table class="table table-sm table-bordered table-striped" id="' + tabName 
                                + '-table" style="font-size: 11px"></table></div>';
            }

            $('#nav-tab').append(navTab);
            $('#nav-tabContent').append(navTabContent);            
        }

        async function getTable(tabName){
            var sec_json = await getJsonData("https://evenbeiter.github.io/ticker.json"); //get security list
            var sec = sec_json[tabName];

            // get json url
            jsonUrl_url = "https://lt.morningstar.com/api/rest.svc/klr5zyak8x/security/screener?page=1&pageSize=500&outputType=json&version=1&languageId=zh-TW";
            jsonUrl_uni = "&universeIds=FOTWN$$ALL|FOLUX$$ALL|ETALL$$ALL|IXALL$$ALL";
            jsonUrl_data = "&securityDataPoints=SecId|PerformanceId|ISIN|Name|LegalName|CategoryId|CategoryName|PriceCurrency|ClosePrice|GBRReturnD1|GBRReturnW1|GBRReturnM1|GBRReturnM3|GBRReturnM6|GBRReturnM0|GBRReturnM12|GBRReturnM36|GBRReturnM60|GBRReturnM120|MaxFrontEndLoad|FundTNAV|FundTNAVDate|StandardDeviationM12|StandardDeviationM36|SharpeM36|ClosePriceDate|InceptionDate|investmenttype|BrandingCompanyId";
            jsonUrl_dataAll = "&securityDataPoints=ISIN|SecId|PerformanceId|Name|LegalName|PriceCurrency|CategoryName|ClosePrice|StarRatingM255|SustainabilityRank|QuantitativeRating|AnalystRatingScale|Yield_M12|GBRReturnD1|GBRReturnW1|GBRReturnM1|GBRReturnM3|GBRReturnM6|GBRReturnM0|GBRReturnM12|GBRReturnM36|GBRReturnM60|GBRReturnM120|MaxFrontEndLoad|OngoingCharge|OngoingCostActual|PerformanceFeeActual|TransactionFeeActual|MaximumExitCostAcquired|FeeLevel|ManagerTenure|MaxDeferredLoad|InitialPurchase|FundTNAV|EquityStyleBox|BondStyleBox|AverageMarketCapital|AverageCreditQualityCode|EffectiveDuration|MorningstarRiskM255|AlphaM36|BetaM36|R2M36|StandardDeviationM36|SharpeM36|InvestorTypeRetail|InvestorTypeProfessional|InvestorTypeEligibleCounterparty|ExpertiseBasic|ExpertiseAdvanced|ExpertiseInformed|ReturnProfilePreservation|ReturnProfileGrowth|ReturnProfileIncome|ReturnProfileHedging|ReturnProfileOther|TrackRecordExtension";
            jsonUrl_pfId = "&term=" + sec.join(" ");

            mstarFile = jsonUrl_url + jsonUrl_uni + jsonUrl_data + jsonUrl_pfId;

            // append thead & tbody
            let tHeadBody = `
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th></th>
                                <th>CCY</th>
                                <th>NAV</th>
                                <th>1D</th>
                                <th>1W</th>
                                <th>1M</th>
                                <th>3M</th>
                                <th>6M</th>
                                <th>YTD</th>
                                <th>1Y</th>
                                <th>3Y</th>
                                <th>5Y</th>
                                <th>AUM</th>
                                <th>1Y SD</th>
                                <th>3Y SD</th>
                                <th>Date</th>
                                <th>AUM Date</th>
                                <th>Inception</th>
                                <th>Pf ID</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                        `;                    

            $('#' + tabName + '-table').append(tHeadBody);

            var mstar_data = await getJsonData(mstarFile);

            let rows_data = mstar_data["rows"];

            rows_data.forEach(function (data) {

                // add security token; define css class
                var sec_token = "";
                var cssClassTr = "";
                var cssClassTd = "";
                
                if (data.BrandingCompanyId == "BN000009J2") { //NB funds
                    cssClassTd = ' class="td-nbf"';
                } else {
                    cssClassTd = ' class="td-non-nbf"';
                }

                if (data.investmenttype == "IX") { //index
                    sec_token = data.SecId + ']7]0]' + 'IXALL$$ALL';
                    cssClassTr = ' class="tr-ind"';
                } else if (data.ISIN.slice(0, 2) == "TW") { //TW registered
                    sec_token = data.SecId + ']2]0]' + data.investmenttype + 'TWN$$ALL';
                    cssClassTr = ' class="tr-twn"';
                } else if (data.investmenttype == "FO") {
                    sec_token = data.SecId + ']22]0]' + 'UNIVE$$ALL'; //including ETF
                }


                data.SecurityToken = sec_token;


                var dec = 1; //define number of decimals

                var sec_data = '';
                sec_data += '<tr' + cssClassTr + ' order="' + sec.indexOf(data.PerformanceId) + '">';

                sec_data += '<td' + cssClassTd +'><input type="checkbox" style="margin-right: 5px" id="' + data.PerformanceId + '" name="fund" value="' + data.SecurityToken + '"><a href="https://sfiles.cnyes.cool/funds/files/prod/' + data.PerformanceId + '/monthlyReport.pdf" target="_blank">' + data.Name + '</td>'
                sec_data += '<td>' + '<a href="http://globaldocuments.morningstar.com/DocumentLibrary/dochistory.aspx?secId=' + data.SecId + '" target="_blank">GL</td>'
                sec_data += '<td>' + data.PriceCurrency + '</td>'
                sec_data += '<td class="text-right">' + parseFloat(data.ClosePrice).toFixed(2) + '</td>'
                sec_data += '<td class="text-right heat-map">' + parseFloat(data.GBRReturnD1).toFixed(dec) + '</td>'
                sec_data += '<td class="text-right heat-map">' + parseFloat(data.GBRReturnW1).toFixed(dec) + '</td>'
                sec_data += '<td class="text-right heat-map">' + parseFloat(data.GBRReturnM1).toFixed(dec) + '</td>'
                sec_data += '<td class="text-right heat-map">' + parseFloat(data.GBRReturnM3).toFixed(dec) + '</td>'
                sec_data += '<td class="text-right heat-map">' + parseFloat(data.GBRReturnM6).toFixed(dec) + '</td>'
                sec_data += '<td class="text-right heat-map">' + parseFloat(data.GBRReturnM0).toFixed(dec) + '</td>'
                sec_data += '<td class="text-right heat-map">' + parseFloat(data.GBRReturnM12).toFixed(dec) + '</td>'
                sec_data += '<td class="text-right heat-map">' + parseFloat(data.GBRReturnM36).toFixed(dec) + '</td>'
                sec_data += '<td class="text-right heat-map">' + parseFloat(data.GBRReturnM60).toFixed(dec) + '</td>'
                sec_data += '<td class="text-right">' + formatNumber((parseFloat(data.FundTNAV) / 1000000).toFixed(0)) + '</td>'
                sec_data += '<td class="text-right">' + parseFloat(data.StandardDeviationM12).toFixed(dec) + '</td>'
                sec_data += '<td class="text-right">' + parseFloat(data.StandardDeviationM36).toFixed(dec) + '</td>'

                sec_data += '<td>' + data.ClosePriceDate + '</td>'
                sec_data += '<td>' + data.FundTNAVDate + '</td>'
                sec_data += '<td>' + data.InceptionDate + '</td>'
                sec_data += '<td>' + data.PerformanceId + '</td>'

                sec_data += '</tr>';

                $('#' + tabName + '-table').append(sec_data);

            })


            // reorder table rows
            // 1. sort table rows
            var sortedTableRows = $('#' + tabName + '-table tbody tr').get().sort(function (a, b) {
                var aVal = +a.getAttribute('order');
                var bVal = +b.getAttribute('order');
                return (aVal > bVal) ? 1 : (aVal < bVal) ? -1 : 0;
            });

            // 2. replace the table rows with the ordered one
            $.each(sortedTableRows, function (i, e) {
                $('#' + tabName + '-table tbody').append(e);
            });

            // 3. replace undefined/NaN with empty string
            document.body.innerHTML = document.body.innerHTML.replace(/undefined/g, '');
            document.body.innerHTML = document.body.innerHTML.replace(/NaN/g, '');



            /************************************/
            // functions for HEATMAP
            /************************************/

            // Function to get the max & value in an Array
            Array.max = function (array) {
                return Math.max.apply(Math, array);
            };

            Array.min = function (array) {
                return Math.min.apply(Math, array);
            }

            // Get all data values from our table cells making sure to ignore the first column of text
            // Use the parseInt function to convert the text string to a number
            var counts = $('#' + tabName + '-table td.heat-map').map(function () {
                if (parseFloat($(this).text()) === null || parseFloat($(this).text()) === "" || isNaN(parseFloat($(this).text()))) {
                    return 0.0;
                } else {
                    return parseFloat($(this).text());
                }
            }).get();

            // run max value function and store in variable
            var max = Array.max(counts);
            var min = Array.min(counts);
            var pos = 0;

            n = 100; // Declare the number of groups

            // Define the colour for value = zero: white
            zr = 255; // Red value
            zg = 255; // Green value
            zb = 255; // Blue value

            // Define the starting colour for positive#: green
            pr = 99; // Red value
            pg = 190; // Green value
            pb = 123; // Blue value

            // Define the negative starting colour for negative#: red
            nr = 248; // Red value
            ng = 105; // Green value
            nb = 107; // Blue value

            // Loop through each data point and calculate its % value
            $('#' + tabName + '-table td.heat-map').not(":empty").each(function () {
                var val = parseFloat($(this).text());

                if (val === 0) {
                    red = zr;
                    green = zg;
                    blue = zb;
                } else if (val > 0) {
                    pos = parseFloat((Math.round((val / max) * 100)).toFixed(0));
                    red = parseFloat((zr + ((pos * (pr - zr)) / (n - 1))).toFixed(0));
                    green = parseFloat((zg + ((pos * (pg - zg)) / (n - 1))).toFixed(0));
                    blue = parseFloat((zb + ((pos * (pb - zb)) / (n - 1))).toFixed(0));
                } else if (val < 0) {
                    pos = parseFloat((Math.round(-(val / min) * 100)).toFixed(0)); //make min absolute value
                    red = parseFloat((zr + ((- pos * (nr - zr)) / (n - 1))).toFixed(0));
                    green = parseFloat((zg + ((- pos * (ng - zg)) / (n - 1))).toFixed(0));
                    blue = parseFloat((zb + ((- pos * (nb - zb)) / (n - 1))).toFixed(0));
                }

                clr = 'rgb(' + red + ',' + green + ',' + blue + ')';
                $(this).css('background-color', clr);

            });            
        }



        /************************************/
        // functions to get PLOTLY CHART
        /************************************/

        function plotlyChart() {
            document.getElementById('light').style.display = 'block';
            document.getElementById('fade').style.display = 'block';
            document.getElementById('comp').innerHTML = "";
            makePlotly();
        }


        function closeChart() {
            document.getElementById('light').style.display = 'none';
            document.getElementById('fade').style.display = 'none';
            clearAll();
        }




        /************************************/
        // functions to get SEC INFO
        /************************************/

        function getSecInfo() {
            var token = [];
            var fundName = [];
            var ccy = [];
            var incept = [];
            $("table > tbody > tr").each(function () {
                var chk = $(this).find('input:checkbox');
                if (chk.is(':checked')) {
                    token.push(chk.val());
                    fundName.push($(this).find('td').eq(0).text());
                    ccy.push($(this).find('td').eq(2).text());
                    incept.push($(this).find('td').eq(18).text());
                }
            });
            console.log(token, fundName, ccy, incept);
        }




        /************************************/
        // CHARTING
        /************************************/

        /************************************/
        // functions for CHARTING
        /************************************/

        async function makePlotly() {
            // 1. define data and layout; 2. charting
            var layout = {
                xaxis: {
                    showgrid: false,
                },
                yaxis: {
                    showgrid: false,
                },
                showlegend: true,
                legend: {
                    x: 0.1,
                    y: 1.2
                },
            };
            var data = await getData();
            Plotly.newPlot("comp", data, layout);
        }

        async function getData() {
            var data = []; //clear previous data

            // get secInfo from user selection
            var token = [];
            var fundName = [];
            var ccy = [];
            var incept = [];
            var lastNavDate = [];
            $("table > tbody > tr").each(function () {
                var chk = $(this).find('input:checkbox');
                if (chk.is(':checked')) {
                    token.push(chk.val());
                    fundName.push($(this).find('td').eq(0).text());
                    ccy.push($(this).find('td').eq(2).text());
                    incept.push($(this).find('td').eq(18).text());
                    lastNavDate.push($(this).find('td').eq(16).text());
                }
            });

            // determine end date
            if ($("#endDate").val() == null | $("#endDate").val() == "") {
                //do nothing
            } else {
                lastNavDate.push(convertDate($("#endDate").val()));
            }
            var eDates = lastNavDate.map(x => new Date(x));
            var endDate = toDate(eDates); //yyyy-mm-dd

            // determine start date
            if ($("#startDate").val() == null || $("#startDate").val() == '') {
                incept.push(yearAgo(endDate, 1));
            } else {
                incept.push(convertDate($("#startDate").val()));
            }
            var sDates = incept.map(x => new Date(x));
            var startDate = fromDate(sDates); //yyyy-mm-dd


            json_url = "https://tools.morningstar.co.uk/api/rest.svc/timeseries_cumulativereturn/t92wz0sj7c?idtype=Morningstar&priceType=&outputType=COMPACTJSON&decPlaces=2&applyTrackRecordExtension=true";
            json_frq = "&frequency=daily";
            var json_str = "&startDate=" + startDate;
            var json_end = "&endDate=" + endDate;
            var colors = ['rgb(110,141,176)', 'rgb(173,174,176)', 'rgb(55,81,114)', 'rgb(95,130,137)', 'rgb(110,178,189)', 'rgb(220,181,150)',
                'rgb(192,109,89)', 'rgb(103,112,122)', 'rgb(76,180,231)', 'rgb(166,169,123)', 'rgb(241,225,213)', 'rgb(157,182,187)'];

            // include dates data into from/to fields
            $("#startDate").val(convertDateReverse(startDate));
            $("#endDate").val(convertDateReverse(endDate));

            // user input ccy for charting
            var ccyUserInput = [$("#ccy01").val(), $("#ccy02").val(), $("#ccy03").val(), $("#ccy04").val()];

            for (var i = 0; i < ccy.length; i++) {
                if (ccyUserInput[i] == null || ccyUserInput[i] == "") {
                    ccy[i] = ccy[i];
                } else {
                    ccy[i] = ccyUserInput[i];
                }
            }

            // looping to get data
            for (var i = 0; i < token.length; i++) {
                var priceCurrency = "";
                if (ccy[i] == null || ccy[i] == "") {
                    priceCurrency = "USD";
                } else { priceCurrency = ccy[i] };

                var json_ccy = "&currencyId=" + priceCurrency;
                var json_id = "&id=" + token[i];
                var json = json_url + json_ccy + json_frq + json_str + json_end + json_id;

                var sec_id = "&term=" + token[i].slice(0, 10);
                // var secInfo = sec_url + sec_uni + sec_data + sec_id;

                var trace = await getTrace(json, fundName[i], colors[i]);
                data.push(trace);

                // include data into input fields
                $("#ticker0" + (i + 1)).val(token[i]);
                $("#ccy0" + (i + 1)).val(ccy[i]);
                $("#name0" + (i + 1)).val(fundName[i]);
                $("#tr0" + (i + 1)).val(trace["y"][trace["y"].length - 1]);
            }
            return data;
        }

        async function getTrace(url, name, clr) {
            var trace = await getXY(url);
            trace.name = name;
            trace.line = { color: clr };
            return trace;
        }

        async function getXY(url) {
            var date = [];
            var value = [];
            var res = await getJsonData(url);
            res.forEach(function (val) {
                date.push(plotlyDate(val[0]));
                value.push(val[1]);
            });
            return { x: date, y: value, type: 'scatter', mode: 'lines' };
        }

        function getJsonData(url) {
            return new Promise((resolve, reject) => {
                resolve($.getJSON(url));
            })
        }




        /************************************/
        // functions for DATES
        /************************************/

        function fromDate(dates) {
            var latest = new Date(Math.max.apply(null, dates));
            return dateFormat(latest);
        }

        function toDate(dates) {
            var earliest = new Date(Math.min.apply(null, dates));
            return dateFormat(earliest);
        }

        function convertDate(date) { //convert yyyymmdd format to yyyy-mm-dd
            return [date.slice(0, 4), date.slice(4, 6), date.slice(6, 8)].join('-');
        }

        function convertDateReverse(date) { //convert yyyy-mm-dd format back to yyyymmdd
            return date.slice(0, 4) + date.slice(5, 7) + date.slice(8, 10);
        }

        function lastDay() {
            var dt = new Date();
            dt.setDate(dt.getDate() - 1); //yesterday
            var yyyy = getYYYY(dt);
            var mm = getMM(dt);
            var dd = getDD(dt);
            return [yyyy, mm, dd].join('-')
        }

        function plotlyDate(jsonDate) {
            var dt = new Date(parseInt(jsonDate));
            var dd = dt.getDate();
            var mm = dt.getMonth() + 1; //January is 0! 
            var yyyy = dt.getFullYear();
            if (dd < 10) { dd = '0' + dd }
            if (mm < 10) { mm = '0' + mm }
            return [yyyy, mm, dd].join('-');
        }

        function dateFormat(dt) {
            var dd = dt.getDate();
            var mm = dt.getMonth() + 1; //January is 0! 
            var yyyy = dt.getFullYear();
            if (dd < 10) { dd = '0' + dd }
            if (mm < 10) { mm = '0' + mm }
            return [yyyy, mm, dd].join('-');
        }


        /************************************/
        // calculate TIME FRAME
        /************************************/


        function mthAgo(mth) { //when mth < 12
            var dt = new Date();
            var mm = dt.getMonth() - mth + 1;
            var yyyy = dt.getFullYear();
            if (mm <= 0) {
                mm = mm + 12
                yyyy = yyyy - 1
            } else {
                mm = mm
            }

            var dd = dt.getDate();
            if (dd > getMonthEnd(yyyy, mm)) {
                dd = getMonthEnd(yyyy, mm)
            } else {
                dd = dd
            }

            if (mm < 10) { mm = '0' + mm };
            if (dd < 10) { dd = '0' + dd };

            return [yyyy, mm, dd].join('-')
        }

        // function yearAgo(yr){
        //     var dt = new Date();
        //     var yyyy = getYYYY(dt) - yr;
        //     var mm = getMM(dt);
        //     var dd = getDD(dt);
        //     return [yyyy, mm, dd].join('-');
        // }

        function yearAgo(dt, yr) { //yyyy-mm-dd
            var yyyy = dt.slice(0, 4) - yr;
            var mm = dt.slice(5, 7);
            var dd = dt.slice(8, 10);
            return [yyyy, mm, dd].join('-');
        }

        function lastYearEnd() {
            var dt = new Date(); //today()
            return (getYYYY(dt) - 1) + "-12-31";
        }

        function getDD(dt) {
            var dd = dt.getDate();
            if (dd < 10) { dd = '0' + dd };
            return dd;
        }

        function getMM(dt) {
            var mm = dt.getMonth() + 1; //January is 0! 
            if (mm < 10) { mm = '0' + mm };
            return mm;
        }

        function getYYYY(dt) {
            var yyyy = dt.getFullYear();
            return yyyy;
        }

        function getMonthEnd(yyyy, m) {
            day = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
            dayR = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
            if (yyyy % 4 == 0) {
                return dayR[m - 1];
            } else {
                return day[m - 1];
            }
        }








        /************************************/
        // functions to get chart url
        /************************************/

        // 1. get tickers first
        function ticker() {
            var tickers = $('input[name="fund"]:checked').map(function () {
                return this.value;
            }).get().join('|');
            return tickers;
        }

        // 2. get chart url
        function getChart() {
            var ccy = "";
            if (document.getElementById("ccy").value == null || document.getElementById("ccy").value == "") {
                ccy = "USD"
            } else {
                ccy = document.getElementById("ccy").value
            };

            // var sec = document.getElementById("").value;
            url_url = "https://tools.morningstar.co.uk/uk/interactivechart/htmlv2/default.aspx?embedded=true";
            url_ccy = "&CurrencyId=" + ccy;
            url_sec = "&SecurityTokenList=" + ticker();
            chartUrl = url_url + url_ccy + url_sec;
            // document.getElementById("myChart").src = chartUrl;
            window.open(chartUrl, "_blank", width = 1000, height = 800)
        }



        /************************************/
        // clear all
        /************************************/

        function clearAll() {
            $("input:text").val("");
            $('input:checkbox').prop("checked", false);
        }

        /************************************/
        // refresh nav tab
        /************************************/

        function refresh(){
            var tabName = $('.nav-tabs .active').text().toLowerCase();
            $('#' + tabName + '-table').empty();
            getTable(tabName);
        }



        /************************************/
        // format numbers
        /************************************/
        function formatNumber(num) {
            return num.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,')
        }

        /************************************/
        // spinner
        /************************************/
        function hideSpinner() { 
            document.getElementById('spinner') 
                    .style.display = 'none'; 
        }  

    </script>

    <!-- bootstrap -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
</body>

</html>
