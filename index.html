<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Daily</title>

    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- jquery UI & mousewheel -->
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
        integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-mousewheel/3.1.13/jquery.mousewheel.min.js"></script>
    <!-- bootstrap stylesheet -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <!-- jquery UI stylesheet -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">

    <!-- HTML Codes by Quackit.com -->

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        table.table.table-striped tr:hover td {
            background-color: #d4e3f2;
        }

        th,
        td {
            white-space: nowrap;
            line-height: 9px;
            min-height: 9px;
            height: 9px;
        }


        /* css to freeze pane */
        .tab-pane {
            overflow: auto;
            width: 100%;
            height: 80vh;
        }

        th {
            background-color: white;
        }

        table {
            table-layout: auto;
            width: 100%;
        }

        td:first-child,
        th:first-child {
            position: sticky;
            left: 0;
            z-index: 1;
        }

        thead tr th {
            position: sticky;
            top: 0;
        }

        th:first-child {
            z-index: 2
        }

        .tr-ind,
        .tr-ind a {
            color: firebrick;
        }

        .tr-twn {
            color: blue;
        }

        table.table.table-striped td.td-nbf {
            background-color: #d4e3f2;
        }

        table.table td.td-non-nbf {
            background-color: white;
        }

        .table-striped tr:nth-child(odd) td {
            background-color: #f9f9f9;
        }

        .clear-both {
            clear: both;
        }

        .inputfield {
            height: 25px;
        }

        .w-ticker {
            width: 200px;
        }

        .w-ccy {
            width: 60px;
        }

        .w-name {
            width: 350px;
        }

        .w-tr {
            width: 60px;
        }

        .input-numbers {
            font-size: 12px;
            text-align: right;
        }

        .input-text {
            font-size: 12px;
        }

        /* for chart overlay */
        .black_overlay {
            display: none;
            position: absolute;
            top: 0%;
            left: 0%;
            width: 100%;
            height: 100%;
            background-color: black;
            z-index: 1001;
            -moz-opacity: 0.6;
            opacity: .60;
            filter: alpha(opacity=66);
        }

        .white_content {
            display: none;
            position: absolute;
            top: 5vh;
            /* left: 5%; */
            width: 100%;
            height: 90vh;
            padding: 3px;
            border: 1px solid gray;
            background-color: white;
            z-index: 1002;
            overflow: auto;
        }
    </style>

</head>

<body>

    <!-- LOADING **************************************************************************************************-->

    <div class="d-flex justify-content-center">
        <div class="spinner-border" role="status" id="spinner">
          <span class="sr-only">Loading...</span>
        </div>
    </div>

    <!-- PERFORMANCE TABLE **************************************************************************************-->

    <!-- bootstrap nav tabs START -->
    <nav>
            <div class="nav nav-tabs" id="nav-tab" role="tablist"></div>
        </nav>
    
        <div class="tab-content" id="nav-tabContent"></div>
        <!-- bootstrap nav tabs END -->
    
        <br>
        <div class="col col-sm-12 col-md-6 float-left">
            <div class="input-group input-group-sm mb-3" style="width: 120px; float: left; margin-right: 5px">
                <div class="input-group-prepend">
                    <span class="input-group-text" id="inputGroup-sizing-sm">CCY</span>
                </div>
                <input id="ccy" type="text" class="form-control" aria-label="currency" aria-describedby="inputGroup-sizing-sm">
            </div>
            <div class="float-left">
                <button class="btn btn-light btn-sm" onclick="getMsChart()">MStar</button>
                <button class="btn btn-light btn-sm" onclick="clearAll()">Clear</button>
                <button class="btn btn-light btn-sm" onclick="refresh()">Refresh</button>
                <button class="btn btn-light btn-sm" onclick="secInfo()">Info</button>
                <button class="btn btn-light btn-sm" onclick="newWindowChart()">Chart</button>
            </div>
        </div>
    
        <div class="col col-sm-12 col-md-6 float-left">
            <div class="input-group input-group-sm mb-3" style="width: 300px; float: left; margin-left: 5px; margin-right: 5px">
                <input id="search-value" type="text" class="form-control" aria-label="search-value"
                    aria-describedby="inputGroup-sizing-sm">
            </div>
            <button class="btn btn-light btn-sm float-left" onclick="search()">Search</button>
            </div>
        </div>

    <!-- POP UP CHART *********************************************************************************************-->
    <div id="light" class="white_content">
        <p style='text-align: right'><a href="javascript:void(0)" onclick="closeChart()">CLOSE</a>
        </p>

    <!-- PLOTLY CHART *********************************************************************************************-->
        <!-- from/to dates input fields ***************************************************************************-->
        <div class="col col-sm-12 col-lg-6 clear-both">
            <div class="input-group input-group-sm mb-3" style="width: 150px; float: left; margin-right: 5px">
                <div class="input-group-prepend">
                    <span class="input-group-text" id="inputGroup-sizing-sm">From</span>
                </div>
                <input id="startDate" type="text" class="form-control" aria-label="startDate"
                    aria-describedby="inputGroup-sizing-sm">
            </div>

            <div class="input-group input-group-sm mb-3" style="width: 150px; float: left; margin-right: 5px">
                <div class="input-group-prepend">
                    <span class="input-group-text" id="inputGroup-sizing-sm">To</span>
                </div>
                <input id="endDate" type="text" class="form-control" aria-label="endDate"
                    aria-describedby="inputGroup-sizing-sm">
            </div>
            
            <button id="keep-comp-table" class="btn btn-light btn-sm" onclick="makePlotly()">Chart</button>
        </div>

        <!-- ticker, currency, name and return fields ********************************************************-->
        <div id="demo" class="col col-sm-12 col-md-12 col-lg-8 clear-both">
            <table id="comp-table" style="font-size: 11px">
            </table>
        </div>

        <!-- charting area ************************************************************************************-->

        <div class="clear-both">
            <div class="col col-sm-12 col-lg-6 clear-both">
                    <button class="btn btn-light btn-sm" onclick="m1Chart()">1M</button>
                    <button class="btn btn-light btn-sm" onclick="m3Chart()">3M</button>
                    <button class="btn btn-light btn-sm" onclick="m6Chart()">6M</button>
                    <button class="btn btn-light btn-sm" onclick="ytdChart()">YTD</button>
                    <button class="btn btn-light btn-sm" onclick="y1Chart()">1Y</button>
                    <button class="btn btn-light btn-sm" onclick="y2Chart()">2Y</button>
                    <button class="btn btn-light btn-sm" onclick="y3Chart()">3Y</button>
                    <button class="btn btn-light btn-sm" onclick="y5Chart()">5Y</button>
                    <button class="btn btn-light btn-sm" onclick="y10Chart()">10Y</button>
                    <button class="btn btn-light btn-sm" onclick="maxChart()">MAX</button>
            </div>

            <div id="comp" class="col col-sm-12 col-lg-8 clear-both" style="height: 75%"></div>
        </div>

    <!-- PLOTLY CHART ENDS **************************************************************************************-->

    </div>
    <div id="fade" class="black_overlay"></div>



    <script>

        $(document).ready(async function () {
            let res = await Promise.all([
                createPage('nb'),
                createPage('mac'),
                createPage('hyb'),
                createPage('ghy'),
                createPage('ig'),
                createPage('si'),
                createPage('emd'),
                createPage('cb'),
                createPage('eme'),
                createPage('ge'),
                createPage('use'),
                createPage('fivg'),
                createPage('reit'),
                createPage('ar'),
                createPage('project'),
                createTab('search')               
            ]);
            if (res) { hideSpinner() };
        })


        // PERFORMANCE TABLE ***************************************************************************************************************

        function createPage(tabName) {
            createTab(tabName);
            getTable(tabName);
        }

        function createTab(tabName){
            // append nav tab & tab content
            var navTab = "";
            var navTabContent = "";

            if (tabName == 'nb'){ //default active tab
                navTab = '<a class="nav-item nav-link active" id="nav-' + tabName + '-tab" data-toggle="tab" href="#nav-' + tabName 
                                + '" role="tab" aria-controls="nav-' + tabName + '" aria-selected="true">' + tabName.toUpperCase() + '</a>';                
                navTabContent = '<div class="tab-pane fade show active" id="nav-' + tabName + '" role="tabpanel" aria-labelledby="nav-' + tabName + '-tab">'
                                + '<table class="table table-sm table-bordered table-striped" id="' + tabName
                                + '-table" style="font-size: 11px"></table></div>'; 

            } else {
                navTab = '<a class="nav-item nav-link" id="nav-' + tabName + '-tab" data-toggle="tab" href="#nav-' + tabName 
                                + '" role="tab" aria-controls="nav-' + tabName + '" aria-selected="true">' + tabName.toUpperCase() + '</a>';                
                navTabContent = '<div class="tab-pane fade" id="nav-' + tabName + '" role="tabpanel" aria-labelledby="nav-' + tabName + '-tab">'
                                + '<table class="table table-sm table-bordered table-striped" id="' + tabName
                                + '-table" style="font-size: 11px"></table></div>';
            }

            $('#nav-tab').append(navTab);
            $('#nav-tabContent').append(navTabContent);     
        }

        const jsonUrl_url = "https://lt.morningstar.com/api/rest.svc/klr5zyak8x/security/screener?page=1&pageSize=5000&outputType=json&version=1&languageId=zh-TW";
        var jsonUrl_uni = "";
        const jsonUrl_data = "&securityDataPoints=SecId|PerformanceId|ISIN|Name|LegalName|CategoryId|CategoryName|PriceCurrency|ClosePrice|GBRReturnD1|GBRReturnW1|GBRReturnM1|GBRReturnM3|GBRReturnM6|GBRReturnM0|GBRReturnM12|GBRReturnM36|GBRReturnM60|GBRReturnM120|MaxFrontEndLoad|FundTNAV|FundTNAVDate|StandardDeviationM12|StandardDeviationM36|SharpeM36|ClosePriceDate|InceptionDate|investmenttype|BrandingCompanyId|PrimaryBenchmarkId|PrimaryBenchmarkName";
        const jsonUrl_dataAll = "&securityDataPoints=ISIN|SecId|PerformanceId|Name|LegalName|PriceCurrency|CategoryName|ClosePrice|StarRatingM255|SustainabilityRank|QuantitativeRating|AnalystRatingScale|Yield_M12|GBRReturnD1|GBRReturnW1|GBRReturnM1|GBRReturnM3|GBRReturnM6|GBRReturnM0|GBRReturnM12|GBRReturnM36|GBRReturnM60|GBRReturnM120|MaxFrontEndLoad|OngoingCharge|OngoingCostActual|PerformanceFeeActual|TransactionFeeActual|MaximumExitCostAcquired|FeeLevel|ManagerTenure|MaxDeferredLoad|InitialPurchase|FundTNAV|EquityStyleBox|BondStyleBox|AverageMarketCapital|AverageCreditQualityCode|EffectiveDuration|MorningstarRiskM255|AlphaM36|BetaM36|R2M36|StandardDeviationM36|SharpeM36|InvestorTypeRetail|InvestorTypeProfessional|InvestorTypeEligibleCounterparty|ExpertiseBasic|ExpertiseAdvanced|ExpertiseInformed|ReturnProfilePreservation|ReturnProfileGrowth|ReturnProfileIncome|ReturnProfileHedging|ReturnProfileOther|TrackRecordExtension";
        var jsonUrl_id = "";

        async function getTable(tabName){
            var sec_json = await getJsonData("https://evenbeiter.github.io/ticker.json"); //get security list
            var sec = [];

            if (tabName == 'search') {
                sec = $('#search-value').val().split(' ');
            } else {
                sec = sec_json[tabName];
            }

            if (tabName == "nb") {
                jsonUrl_uni = "&universeIds=FOTWN$$ALL";
                jsonUrl_id = "&filters=BrandingCompanyId:EQ:BN000009J2";
            } else {
                jsonUrl_uni = "&universeIds=FOTWN$$ALL|FOGBR$$ALL|FOLUX$$ALL|ETALL$$ALL|IXALL$$ALL";
                jsonUrl_id = "&term=" + sec.join(" ");
            }

            mstarFile = jsonUrl_url + jsonUrl_uni + jsonUrl_data + jsonUrl_id;

            // append thead & tbody
            let tHeadBody = `
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Info</th>
                                <th>CCY</th>
                                <th>NAV</th>
                                <th>1D</th>
                                <th>1W</th>
                                <th>1M</th>
                                <th>3M</th>
                                <th>6M</th>
                                <th>YTD</th>
                                <th>1Y</th>
                                <th>3Y</th>
                                <th>5Y</th>
                                <th>AUM</th>
                                <th>1Y SD</th>
                                <th>3Y SD</th>
                                <th>Date</th>
                                <th>AUM Date</th>
                                <th>Inception</th>
                                <th>SecId</th>
                                <th>PerformanceId</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                        `;                    

            $('#' + tabName + '-table').append(tHeadBody);

            var mstar_data = await getJsonData(mstarFile);
            let rows_data = mstar_data["rows"];

            var fx_data = await getJsonData("https://api.exchangeratesapi.io/history?start_at=" + mthAgo(lastDay(), 5) + "&end_at=" + lastDay() +"&base=GBP&symbols=USD");
            let gbp_data = fx_data["rates"];
            let gbp_dt = Object.keys(gbp_data);

            rows_data.forEach(async function (data) {

                // add security token; define css class
                var sec_token = "";
                var cssClassTr = "";
                var cssClassTd = "";

                // get GBP to convert AUM into USD based
                var gbpUSD = 1.00;
                if (typeof data.FundTNAVDate !== 'undefined'){
                    var getGbpDate = "";
                    if (convertDateToSystem(data.FundTNAVDate).getDay() == 6) { // if aum date is on Sat
                        getGbpDate = new Date(convertDateToSystem(data.FundTNAVDate) - 1).toLocaleDateString('fr-CA');
                    } else if (convertDateToSystem(data.FundTNAVDate).getDay() == 0) { // if aum date is on Sun
                        getGbpDate = new Date(convertDateToSystem(data.FundTNAVDate) - 2).toLocaleDateString('fr-CA');
                    } else {
                        getGbpDate = data.FundTNAVDate;
                    }

                    gbp_dt.forEach(function(dt){
                        if(dt == getGbpDate) {
                            gbpUSD = gbp_data[dt]["USD"];
                        }
                    })                
                }

                if (data.BrandingCompanyId == "BN000009J2") { //NB funds
                    cssClassTd = ' class="td-nbf"';
                } else {
                    cssClassTd = ' class="td-non-nbf"';
                }

                if (data.investmenttype == "IX") { //index
                    sec_token = data.SecId + ']7]0]' + 'IXALL$$ALL';
                    cssClassTr = ' class="tr-ind"';
                } else if (typeof data.ISIN !== 'undefined') {
                    if (data.ISIN.slice(0, 2) == "TW") { //TW registered
                        sec_token = data.SecId + ']2]0]' + data.investmenttype + 'TWN$$ALL';
                        cssClassTr = ' class="tr-twn"';
                    } 
                } else if (data.investmenttype == "FO") {
                    sec_token = data.SecId + ']22]0]' + 'UNIVE$$ALL'; //including ETF
                }

                data.SecurityToken = sec_token;

                var dec = 1; //define number of decimals

                var sec_data = '';

                if (tabName == "nb") {
                    sec_data += '<tr' + cssClassTr + '>';
                } else {
                    sec_data += '<tr' + cssClassTr + ' order="' + sec.indexOf(data.PerformanceId) + '">';
                }

                sec_data += '<td' + cssClassTd +'><input type="checkbox" style="margin-right: 5px" id="' + data.PerformanceId + '" name="fund" value="' + data.SecurityToken + '"><a href="https://sfiles.cnyes.cool/funds/files/prod/' + data.PerformanceId + '/monthlyReport.pdf" target="_blank">' + data.Name + '</a></td>'
                sec_data += '<td>'  + '<a href="https://www.morningstar.co.uk/uk/funds/snapshot/p_snapshot.aspx?id=' + data.SecId + '" target="_blank">MS</a>'
                sec_data += ' '  + '<a href="https://www.morningstar.co.uk/uk/funds/snapshot/snapshot.aspx?id=' + data.SecId + '&tab=12" target="_blank">DX</a>'
                sec_data += ' '  + '<a href="http://globaldocuments.morningstar.com/DocumentLibrary/dochistory.aspx?secId=' + data.SecId + '" target="_blank">GL</a></td>'
                
                // sec_data += '<td' + cssClassTd +'><input type="checkbox" style="margin-right: 5px" id="' + data.PerformanceId + '" name="fund" value="' + data.SecurityToken + '"><a href="https://sfiles.cnyes.cool/funds/files/prod/' + data.PerformanceId + '/monthlyReport.pdf" target="_blank">' + data.Name + '</a></td>'
                // sec_data += '<td>' + '<a href="https://www.morningstar.co.uk/uk/funds/snapshot/p_snapshot.aspx?id=' + data.SecId + '" target="_blank">MS</a></td>'
                // sec_data += '<td>' + '<a href="https://www.morningstar.co.uk/uk/funds/snapshot/snapshot.aspx?id=' + data.SecId + '&tab=12" target="_blank">DX</a></td>'
                // sec_data += '<td>' + '<a href="http://globaldocuments.morningstar.com/DocumentLibrary/dochistory.aspx?secId=' + data.SecId + '" target="_blank">GL</a></td>'
                
                sec_data += '<td>' + data.PriceCurrency + '</td>';
                sec_data += '<td class="text-right">' + parseFloat(data.ClosePrice).toFixed(2) + '</td>';
                sec_data += '<td class="text-right heat-map">' + parseFloat(data.GBRReturnD1).toFixed(2) + '</td>';
                sec_data += '<td class="text-right heat-map">' + parseFloat(data.GBRReturnW1).toFixed(dec) + '</td>';
                sec_data += '<td class="text-right heat-map">' + parseFloat(data.GBRReturnM1).toFixed(dec) + '</td>';
                sec_data += '<td class="text-right heat-map">' + parseFloat(data.GBRReturnM3).toFixed(dec) + '</td>';
                sec_data += '<td class="text-right heat-map">' + parseFloat(data.GBRReturnM6).toFixed(dec) + '</td>';
                sec_data += '<td class="text-right heat-map">' + parseFloat(data.GBRReturnM0).toFixed(dec) + '</td>';
                sec_data += '<td class="text-right heat-map">' + parseFloat(data.GBRReturnM12).toFixed(dec) + '</td>';
                sec_data += '<td class="text-right heat-map">' + ((Math.pow(1 + parseFloat(data.GBRReturnM36) / 100, 3) - 1) * 100).toFixed(dec) + '</td>';
                sec_data += '<td class="text-right heat-map">' + ((Math.pow(1 + parseFloat(data.GBRReturnM60) / 100, 5) - 1) * 100).toFixed(dec) + '</td>';
                sec_data += '<td class="text-right">' + formatNumber((parseFloat(data.FundTNAV) / 1000000 * gbpUSD).toFixed(0)) + '</td>';
                sec_data += '<td class="text-right">' + parseFloat(data.StandardDeviationM12).toFixed(dec) + '</td>';
                sec_data += '<td class="text-right">' + parseFloat(data.StandardDeviationM36).toFixed(dec) + '</td>';

                sec_data += '<td>' + data.ClosePriceDate + '</td>';
                sec_data += '<td>' + data.FundTNAVDate + '</td>';
                sec_data += '<td>' + data.InceptionDate + '</td>';
                sec_data += '<td>' + data.SecId + '</td>';
                sec_data += '<td>' + data.PerformanceId + '</td>';

                sec_data += '</tr>';

                $('#' + tabName + '-table').append(sec_data);

            })


            // reorder table rows
            // 1. sort table rows
            var sortedTableRows = $('#' + tabName + '-table tbody tr').get().sort(function (a, b) {
                var aVal = +a.getAttribute('order');
                var bVal = +b.getAttribute('order');
                return (aVal > bVal) ? 1 : (aVal < bVal) ? -1 : 0;
            });

            // 2. replace the table rows with the ordered one
            $.each(sortedTableRows, function (i, e) {
                $('#' + tabName + '-table tbody').append(e);
            });

            // 3. replace undefined/NaN with empty string
            document.body.innerHTML = document.body.innerHTML.replace(/undefined/g, '');
            document.body.innerHTML = document.body.innerHTML.replace(/NaN/g, '');



            // HEAT MAP *************************************************************************************************************

            // Function to get the max & value in an Array
            Array.max = function (array) {
                return Math.max.apply(Math, array);
            };

            Array.min = function (array) {
                return Math.min.apply(Math, array);
            }

            // Get all data values from our table cells making sure to ignore the first column of text
            // Use the parseInt function to convert the text string to a number
            var counts = $('#' + tabName + '-table td.heat-map').map(function () {
                if (parseFloat($(this).text()) === null || parseFloat($(this).text()) === "" || isNaN(parseFloat($(this).text()))) {
                    return 0.0;
                } else {
                    return parseFloat($(this).text());
                }
            }).get();

            // run max value function and store in variable
            var max = Array.max(counts);
            var min = Array.min(counts);
            var pos = 0;

            n = 100; // Declare the number of groups

            // Define the colour for value = zero: white
            zr = 255; // Red value
            zg = 255; // Green value
            zb = 255; // Blue value

            // Define the starting colour for positive#: green
            pr = 99; // Red value
            pg = 190; // Green value
            pb = 123; // Blue value

            // Define the negative starting colour for negative#: red
            nr = 248; // Red value
            ng = 105; // Green value
            nb = 107; // Blue value

            // Loop through each data point and calculate its % value
            $('#' + tabName + '-table td.heat-map').not(":empty").each(function () {
                var val = parseFloat($(this).text());

                if (val === 0) {
                    red = zr;
                    green = zg;
                    blue = zb;
                } else if (val > 0) {
                    pos = parseFloat((Math.round((val / max) * 100)).toFixed(0));
                    red = parseFloat((zr + ((pos * (pr - zr)) / (n - 1))).toFixed(0));
                    green = parseFloat((zg + ((pos * (pg - zg)) / (n - 1))).toFixed(0));
                    blue = parseFloat((zb + ((pos * (pb - zb)) / (n - 1))).toFixed(0));
                } else if (val < 0) {
                    pos = parseFloat((Math.round(-(val / min) * 100)).toFixed(0)); //make min absolute value
                    red = parseFloat((zr + ((- pos * (nr - zr)) / (n - 1))).toFixed(0));
                    green = parseFloat((zg + ((- pos * (ng - zg)) / (n - 1))).toFixed(0));
                    blue = parseFloat((zb + ((- pos * (nb - zb)) / (n - 1))).toFixed(0));
                }

                clr = 'rgb(' + red + ',' + green + ',' + blue + ')';
                $(this).css('background-color', clr);

            });            
        }



        // functions to get NEW WINDOW PLOTLY CHART *********************************************************************************************
        
        function newWindowChart() {
            // 1. clear and make new comp-table
            $('#comp-table').empty(); //clear table
            var numOfRows = $('input[type="checkbox"]:checked').length;
            makeCompTable(numOfRows);

            // 2. show window
            document.getElementById('light').style.display = 'block';
            document.getElementById('fade').style.display = 'block';
            
            // 3. charting
            document.getElementById('comp').innerHTML = "";
            makePlotly();
        }

        function closeChart() {
            document.getElementById('light').style.display = 'none';
            document.getElementById('fade').style.display = 'none';
            clearAll();
        }


        // CHARTING ****************************************************************************************************************************

        function makeCompTable(num){  // COMP TABLE ********************************************************************************************

            // append thead & tbody
            let tHeadBody = `
                            <thead>
                                <tr>
                                    <th>Ticker</th>
                                    <th>CCY</th>
                                    <th>Name</th>
                                    <th class="text-center">TR</th>
                                    <th class="text-center">1Y SD</th>
                                    <th class="text-center">3Y SD</th>
                                    <th class="text-center">SD</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                            `;                    

            $('#comp-table').append(tHeadBody);

            // append row
            var table_row = '';
            for (var i = 1; i < num + 1; i++) {
                table_row += '<tr>';
                table_row += '<td class="w-ticker"><input id="ticker-' + i + '" type="text" class="form-control inputfield input-text w-100" aria-label="ticker-' + i + '" aria-describedby="inputGroup-sizing-sm"></td>';
                table_row += '<td class="w-ccy"><input id="ccy-' + i + '" type="text" class="form-control inputfield input-text w-100" aria-label="ccy-' + i + '" aria-describedby="inputGroup-sizing-sm"></td>';
                table_row += '<td class="w-name"><input id="name-' + i + '" type="text" class="form-control inputfield input-text w-100" aria-label="name-' + i + '" aria-describedby="inputGroup-sizing-sm"></td>';
                table_row += '<td class="w-tr"><input id="tr-' + i + '" type="text" class="form-control inputfield input-numbers w-100" aria-label="tr-' + i + '" aria-describedby="inputGroup-sizing-sm"></td>';
                table_row += '<td class="w-tr"><input id="1y-sd-' + i + '" type="text" class="form-control inputfield input-numbers w-100" aria-label="1y-sd-' + i + '" aria-describedby="inputGroup-sizing-sm"></td>';
                table_row += '<td class="w-tr"><input id="3y-sd-' + i + '" type="text" class="form-control inputfield input-numbers w-100" aria-label="3y-sd-' + i + '" aria-describedby="inputGroup-sizing-sm"></td>';
                table_row += '<td class="w-tr"><input id="custom-sd-' + i + '" type="text" class="form-control inputfield input-numbers w-100" aria-label="custom-sd-' + i + '" aria-describedby="inputGroup-sizing-sm"></td>';
                table_row += '</tr>';
            }

            $('#comp-table').append(table_row);
        }


        async function makePlotly() {  // CHARTING ********************************************************************************************
            
            // 1. define data and layout; 2. charting
            const layout = {
                xaxis: {
                    showgrid: false,
                    fixedrange: true,
                },
                yaxis: {
                    showgrid: false,
                    fixedrange: true,
                },
                showlegend: true,
                legend: {
                    x: 0.1,
                    y: 1.0,
                    bgcolor: 'rgba(0,0,0,0)',
                },
                margin: {
                    l: 30,
                    r: 30,
                    b: 30,
                    t: 30,
                },
                paper_bgcolor: '#f8f8f8',
            };
            const config = {
                responsive: true,
                displayModeBar: false,
            };
            var data = await getData();
            Plotly.newPlot("comp", data, layout, config);
        }


        var endDate = ""; //yyyy-mm-dd
        var startDate = ""; //yyyy-mm-dd

        async function getData() {  // GET DATA ********************************************************************************************

            var data = []; //clear previous data

            // get secInfo from user selection
            var token = [];
            var fundName = [];
            var ccy = [];
            var incept = [];
            var lastNavDate = [];
            $("table > tbody > tr").each(function () {
                var chk = $(this).find('input:checkbox');
                if (chk.is(':checked')) {
                    token.push(chk.val());
                    fundName.push($(this).find('td').eq(0).text());
                    ccy.push($(this).find('td').eq(2).text());
                    incept.push($(this).find('td').eq(18).text());
                    lastNavDate.push($(this).find('td').eq(16).text());
                }
            });


            // determine end date
            if ($("#endDate").val() !== null && $("#endDate").val() !== "") {
                lastNavDate.push(convertDate($("#endDate").val()));
            }
            var eDates = lastNavDate.map(x => new Date(x));
            endDate = toDate(eDates); //yyyy-mm-dd

            // determine start date
            if ($("#startDate").val() == null || $("#startDate").val() == '') {
                incept.push(yearAgo(endDate, 1));
            } else {
                incept.push(convertDate($("#startDate").val()));
            }
            var sDates = incept.map(x => new Date(x));
            startDate = fromDate(sDates); //yyyy-mm-dd

            // include dates data into from/to fields
            $("#startDate").val(convertDateReverse(startDate));
            $("#endDate").val(convertDateReverse(endDate));

            json_url = "https://tools.morningstar.co.uk/api/rest.svc/timeseries_cumulativereturn/t92wz0sj7c?idtype=Morningstar&priceType=&outputType=COMPACTJSON&decPlaces=2&applyTrackRecordExtension=true";
            json_frq = "&frequency=daily";
            var json_str = "&startDate=" + startDate;
            var json_end = "&endDate=" + endDate;
            var colors = ['rgb(110,141,176)', 'rgb(173,174,176)', 'rgb(55,81,114)', 'rgb(95,130,137)', 'rgb(110,178,189)', 'rgb(220,181,150)',
                'rgb(192,109,89)', 'rgb(103,112,122)', 'rgb(76,180,231)', 'rgb(166,169,123)', 'rgb(241,225,213)', 'rgb(157,182,187)'];

            // user input ccy for charting

            var ccyUserInput = [];
            for (var u = 1; u < ccy.length + 1; u++) {
                ccyUserInput.push($('#ccy-' + u).val());
            }

            for (var i = 0; i < ccy.length; i++) {
                if (ccyUserInput[i] == null || ccyUserInput[i] == "") {
                    ccy[i] = ccy[i];
                } else {
                    ccy[i] = ccyUserInput[i];
                }
            }
            

            // looping to get data
            for (var i = 0; i < token.length; i++) {
                var priceCurrency = "";
                if (ccy[i] == null || ccy[i] == "") {
                    priceCurrency = "USD";
                } else { priceCurrency = ccy[i] };

                var json_ccy = "&currencyId=" + priceCurrency;
                var json_id = "&id=" + token[i];
                var json = json_url + json_ccy + json_frq + json_str + json_end + json_id;

                var sec_id = "&term=" + token[i].slice(0, 10); //unused
                // var secInfo = sec_url + sec_uni + sec_data + sec_id;

                var trace = await getTrace(json, fundName[i], colors[i]);
                data.push(trace);

                var sd1y = await getStDev(token[i], priceCurrency, incept[i], lastNavDate[i], 1);
                var sd3y = await getStDev(token[i], priceCurrency, incept[i], lastNavDate[i], 3);

                // include data into input fields
                $("#ticker-" + (i + 1)).val(token[i]);
                $("#ccy-" + (i + 1)).val(ccy[i]);
                $("#name-" + (i + 1)).val(fundName[i]);
                $("#tr-" + (i + 1)).val(trace["y"][trace["y"].length - 1].toFixed(2));
                if (sd1y !== null && sd1y !== "") {
                    $("#1y-sd-" + (i + 1)).val(sd1y.toFixed(2));
                }
                if (sd3y !== null && sd3y !== "") {
                    $("#3y-sd-" + (i + 1)).val(sd3y.toFixed(2));
                }

            }
            return data;
        }

        async function getTrace(url, name, clr) {
            var trace = await getXY(url);
            trace.type = 'scatter';
            trace.mode = 'lines';
            trace.name = name;
            trace.line = { color: clr };
            return trace;
        }

        async function getXY(url) {
            var date = [];
            var value = [];
            var res = await getJsonData(url);
            res.forEach(function (val) {
                date.push(plotlyDate(val[0]));
                value.push(val[1]);
            });
            return { x: date, y: value };
        }

        function getJsonData(url) {
            return new Promise((resolve, reject) => {
                resolve($.getJSON(url));
            })
        }


        // CHARTING different time periods *********************************************************************************************************
      
        function ytdChart() {
            $("#startDate").val(convertDateReverse(lastYearEnd()));
            makePlotly();
        }

        function m1Chart() {
            $("#startDate").val(convertDateReverse(mthAgo(endDate, 1)));
            makePlotly();
        }

        function m3Chart() {
            $("#startDate").val(convertDateReverse(mthAgo(endDate, 3)));
            makePlotly();
        }

        function m6Chart() {
            $("#startDate").val(convertDateReverse(mthAgo(endDate, 6)));
            makePlotly();
        }

        function y1Chart() {
            $("#startDate").val(convertDateReverse(yearAgo(endDate, 1)));
            makePlotly();
        }

        function y2Chart() {
            $("#startDate").val(convertDateReverse(yearAgo(endDate, 2)));
            makePlotly();
        }

        function y3Chart() {
            $("#startDate").val(convertDateReverse(yearAgo(endDate, 3)));
            makePlotly();
        }

        function y5Chart() {
            $("#startDate").val(convertDateReverse(yearAgo(endDate, 5)));
            makePlotly();
        }

        function y10Chart() {
            $("#startDate").val(convertDateReverse(yearAgo(endDate, 10)));
            makePlotly();
        }

        function maxChart() {
            $("#startDate").val(convertDateReverse("1900-01-01"));
            makePlotly();            
        }




        // STDEV *********************************************************************************************************************************

        async function getStDev(token, priceCurrency, fundIncept, endDate, yr){
            var sum = function(x, y){
                return x + y;
            }
            var square = function(x){
                return x * x;
            }

            if (convertDateToSystem(fundIncept) > convertDateToSystem(yearAgo(endDate, yr))){
                return stdev = "";
            } else {
                const json_url = "https://tools.morningstar.co.uk/api/rest.svc/timeseries_cumulativereturn/t92wz0sj7c?idtype=Morningstar&priceType=&outputType=COMPACTJSON&decPlaces=8&applyTrackRecordExtension=true";
                let json_ccy = "&currencyId=" + priceCurrency;
                const json_frq = "&frequency=monthly";
                let json_str = "&startDate=" + yearAgo(endDate, yr);
                let json_end = "&endDate=" + endDate;
                let json_id = "&id=" + token;
                let json = json_url + json_ccy + json_frq + json_str + json_end + json_id;

                let data = await getMthReturn(json);
                let mean = data.reduce(sum)/data.length;
                let deviations = data.map(function(x){
                    return x - mean;
                })
                return stdev = Math.sqrt(deviations.map(square).reduce(sum)/(data.length - 1)) * Math.sqrt(12) * 100;                
            }
        }

        async function getMthReturn(url) {
            var value = [];
            var mthReturn = [];
            var res = await getJsonData(url);
            res.forEach(function (val) {
                value.push(val[1] + 100);
            });

            for (var i = 1; i < value.length; i++) {
                mthReturn.push(value[i] / value[i-1] - 1);
            }
            return mthReturn;
        }


        // DATES *********************************************************************************************************************************

        function fromDate(dates) { //yyyy-mm-dd
            var latest = new Date(Math.max.apply(null, dates));
            return dateFormat(latest);
        }

        function toDate(dates) { //yyyy-mm-dd
            var earliest = new Date(Math.min.apply(null, dates));
            return dateFormat(earliest);
        }

        function convertDate(date) { //convert yyyymmdd format to yyyy-mm-dd
            return [date.slice(0, 4), date.slice(4, 6), date.slice(6, 8)].join('-');
        }

        function convertDateReverse(date) { //convert yyyy-mm-dd format back to yyyymmdd
            return date.replace(/-/g, '');
            // return date.slice(0, 4) + date.slice(5, 7) + date.slice(8, 10);
        }

        function convertDateToSystem(date) { //yyyy-mm-dd to system (for calculation purpose)
            return new Date(date.slice(0, 4), date.slice(5, 7) - 1, date.slice(8, 10));
        }

        function lastDay() { //yyyy-mm-dd
            var dt = new Date();
            dt.setDate(dt.getDate() - 1); //yesterday
            return dt.toLocaleDateString('fr-CA');
        }

        function plotlyDate(jsonDate) { //from json date to yyyy-mm-dd
            var dt = new Date(parseInt(jsonDate));
            return dt.toLocaleDateString('fr-CA');
        }

        function dateFormat(dt) {
            return dt.toLocaleDateString('fr-CA');
        }


        // CALCULATE TIME FRAME *********************************************************************************************************************
      
        function mthAgo(dt, mth) { //dt=yyyy-mm-dd; when mth < 12

            var yyyy = dt.slice(0, 4);
            var mm = dt.slice(5, 7) - mth;
            var dd = dt.slice(8, 10);

            if (mm <= 0) {
                mm = mm + 12
                yyyy = yyyy - 1
            } else { mm = mm }

            if (dd > getMonthEnd(yyyy, mm)) {
                dd = getMonthEnd(yyyy, mm)
            } else { dd = dd }

            if (mm < 10) { mm = '0' + mm };
            if (dd < 10) { dd = '0' + dd };
            return [yyyy, mm, dd].join('-')
        }

        function yearAgo(dt, yr) { //yyyy-mm-dd
            var yyyy = dt.slice(0, 4) - yr;
            var mm = dt.slice(5, 7);
            var dd = dt.slice(8, 10);
            return [yyyy, mm, dd].join('-');
        }

        function lastYearEnd() {
            var dt = new Date(); //today()
            var yyyy = dt.getFullYear() - 1;
            return yyyy + "-12-31";
        }

        function lastMonthEnd(dt) {
            var yyyy = dt.slice(0, 4);
            var mm = dt.slice(5, 7) - 1;

            if (mm <= 0) {
                mm = mm + 12
                yyyy = yyyy - 1
            } else { mm = mm }

            dd = getMonthEnd(yyyy, mm);
            if (mm < 10) { mm = '0' + mm };
            return [yyyy, mm, dd].join('-');
        }

        function getMonthEnd(yyyy, m) {
            day = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
            dayR = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
            if (yyyy % 4 == 0) {
                return dayR[m - 1];
            } else {
                return day[m - 1];
            }
        }

        // GETTING CHART URL *****************************************************************************************************************
      
        // 1. get tickers first
        function ticker() {
            var tickers = $('input[name="fund"]:checked').map(function () {
                return this.value;
            }).get().join('|');
            return tickers;
        }

        // 2. get chart url
        function getMsChart() {
            var ccy = "";
            if (document.getElementById("ccy").value == null || document.getElementById("ccy").value == "") {
                ccy = "USD"
            } else {
                ccy = document.getElementById("ccy").value
            };

            // var sec = document.getElementById("").value;
            url_url = "https://tools.morningstar.co.uk/uk/interactivechart/htmlv2/default.aspx?embedded=true";
            url_ccy = "&CurrencyId=" + ccy;
            url_sec = "&SecurityTokenList=" + ticker();
            chartUrl = url_url + url_ccy + url_sec;
            // document.getElementById("myChart").src = chartUrl;
            window.open(chartUrl, "_blank", width = 1000, height = 800)
        }


        // SEC INFO POP UP *******************************************************************************************************************
        function secInfo(){
            $("table > tbody > tr").each(function () {
                var chk = $(this).find('input:checkbox');
                if (chk.is(':checked')) {
                    jsonUrl_id = "&term=" + chk.val().slice(0, 10);
                    let secInfoUrl = jsonUrl_url + jsonUrl_uni + jsonUrl_dataAll + jsonUrl_id;
                    window.open(secInfoUrl, "_blank", width = 1000, height = 800);
                    $('input:checkbox').prop("checked", false);
                }
            })             
        }

        // CLEAR ALL *************************************************************************************************************************
        function clearAll() {
            $("input:text").val("");
            $('input:checkbox').prop("checked", false);
        }

        // REFRESH NAV TAB *******************************************************************************************************************
        function refresh(){
            var tabName = $('.nav-tabs .active').text().toLowerCase();
            $('#' + tabName + '-table').empty();
            getTable(tabName);                
        }

        // SEARCH ****************************************************************************************************************************
        async function search(){
            $('#search-table').empty();
            $('#nav-search-tab').tab('show');
            await getTable('search');
            $('#search-value').val('');
        }


        // FORMAT NUMBERS ********************************************************************************************************************
        function formatNumber(num) {
            return num.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,')
        }

        // SPINNER ***************************************************************************************************************************
        function showSpinner() { 
            document.getElementById('spinner') 
                    .style.display = 'block'; 
        }  

        function hideSpinner() { 
            document.getElementById('spinner') 
                    .style.display = 'none'; 
        }  

        // CLICK INPUT TO SELECT ALL *********************************************************************************************************
        $("input[type='text']").on("click", function () {
            $(this).select();
        });

    </script>

    <!-- bootstrap -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
</body>

</html>
