<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bilingual EPUB Generator</title>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
<body>
  <h2>Upload EPUBs</h2>
  <input type="file" id="uploadEnglish" accept=".epub">
  <input type="file" id="uploadChinese" accept=".epub">
  <br><br>

  <h3>English EPUB (editable)</h3>
  <textarea id="englishText" style="width:45%;height:200px;"></textarea>

  <h3>Chinese EPUB (editable)</h3>
  <textarea id="chineseText" style="width:45%;height:200px;"></textarea>

  <br><br>
  <button id="generateBtn">Generate Bilingual</button>
  <button id="copyBtn">Copy Result innerHTML</button>
  <button id="exportBtn">Export EPUB</button>

  <h3>Bilingual Result</h3>
  <div id="result" style="border:1px solid black; padding:10px; width:90%; min-height:200px;"></div>

<script>
async function parseEpub(file) {
  const zip = await JSZip.loadAsync(file);
  // 找到 container.xml → 定位 content.opf
  const container = await zip.file("META-INF/container.xml").async("string");
  const parser = new DOMParser();
  const containerDoc = parser.parseFromString(container, "application/xml");
  const opfPath = containerDoc.querySelector("rootfile").getAttribute("full-path");

  const opfText = await zip.file(opfPath).async("string");
  const opfDoc = parser.parseFromString(opfText, "application/xml");

  // 取得 manifest 和 spine
  const manifest = {};
  opfDoc.querySelectorAll("manifest > item").forEach(item => {
    manifest[item.getAttribute("id")] = item.getAttribute("href");
  });

  const spineItems = [];
  opfDoc.querySelectorAll("spine > itemref").forEach(itemref => {
    const idref = itemref.getAttribute("idref");
    spineItems.push(manifest[idref]);
  });

  // 確定 basePath
  const basePath = opfPath.substring(0, opfPath.lastIndexOf("/") + 1);

  // 按順序取內容
  let fullText = "";
  for (const href of spineItems) {
    const filePath = basePath + href;
    if (zip.file(filePath)) {
      const content = await zip.file(filePath).async("string");
      const doc = parser.parseFromString(content, "application/xhtml+xml");
      const bodyText = doc.body.innerHTML;
      if (bodyText) fullText += bodyText;
    }
  }
  return fullText;
}

document.getElementById("uploadEnglish").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (file) {
    const text = await parseEpub(file);
    document.getElementById("englishText").value = text;
  }
});

document.getElementById("uploadChinese").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (file) {
    const text = await parseEpub(file);
    document.getElementById("chineseText").value = text;
  }
});

document.getElementById("generateBtn").addEventListener("click", () => {
  const englishParagraphs = document.getElementById("englishText").value.split(/\n+/).filter(Boolean);
  const chineseParagraphs = document.getElementById("chineseText").value.split(/\n+/).filter(Boolean);
  const resultDiv = document.getElementById("result");
  resultDiv.innerHTML = "";

  const maxLen = Math.max(englishParagraphs.length, chineseParagraphs.length);
  for (let i = 0; i < maxLen; i++) {
    const en = englishParagraphs[i] || "";
    const zh = chineseParagraphs[i] || "";
    resultDiv.innerHTML += `<p><b>EN:</b> ${en}</p><p><b>ZH:</b> ${zh}</p>`;
  }
});

document.getElementById("copyBtn").addEventListener("click", () => {
  const htmlContent = document.getElementById("result").innerHTML;
  navigator.clipboard.writeText(htmlContent).then(() => {
    alert("Result innerHTML copied!");
  });
});

// 簡單的 EPUB 匯出（用 blob zip 打包 XHTML）
document.getElementById("exportBtn").addEventListener("click", async () => {
  const resultHTML = document.getElementById("result").innerHTML;
  const zip = new JSZip();
  zip.file("mimetype", "application/epub+zip");
  zip.file("META-INF/container.xml", `<?xml version="1.0"?>
    <container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">
      <rootfiles>
        <rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/>
      </rootfiles>
    </container>`);

  zip.file("OEBPS/content.opf", `<?xml version="1.0"?>
    <package xmlns="http://www.idpf.org/2007/opf" unique-identifier="BookId" version="3.0">
      <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">
        <dc:title>Bilingual EPUB</dc:title>
        <dc:language>en</dc:language>
      </metadata>
      <manifest>
        <item id="chap1" href="chap1.xhtml" media-type="application/xhtml+xml"/>
      </manifest>
      <spine>
        <itemref idref="chap1"/>
      </spine>
    </package>`);

  zip.file("OEBPS/chap1.xhtml", `<?xml version="1.0" encoding="utf-8"?>
    <html xmlns="http://www.w3.org/1999/xhtml">
    <head><title>Bilingual</title></head>
    <body>${resultHTML}</body></html>`);

  const blob = await zip.generateAsync({type:"blob"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "bilingual.epub";
  a.click();
});
</script>
</body>
</html>