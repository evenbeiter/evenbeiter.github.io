<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPUB to JSON</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
    body {background-color:#F4ECD8;color:#5B4636;font-size:1.2rem;}
    .section_index_title{display:none}
    h1,h2,h3.h4,h5,h6{font-size:1.2rem;color:#3B2D20 !important;font-weight:bold;text-wrap:wrap;}
    h1,h2,h3.h4,h5,h6,p,ul,li{text-wrap: wrap;font-family: 'PingFang TC', 'Hiragino Sans TC', 'Noto Sans TC', sans-serif !important}
    .sepia{background-color:#F4ECD8;color:#5B4636}
    .sepia-contrast{background-color:#3B2D20;color:#F4ECD8}
    .te_article_rubric{font-size:1.2rem;font-weight:bold;font-family: 'PingFang TC', 'Hiragino Sans TC', 'Noto Sans TC', sans-serif !important}
    .te_article_datePublished{font-size:0.9rem;font-family: 'PingFang TC', 'Hiragino Sans TC', 'Noto Sans TC', sans-serif !important}
    img{display:block !important;margin:auto;width:100%;height:auto}
    </style>
</head>
<body>
    <div class="m-3">
        <div id="nav" class="sticky-top sepia-contrast">
            <input type="file" id="fileInput" class="btn"/>
            <button id="convertButton" class="btn sepia">Read</button>
        </div>
    <pre id="output"></pre>
    </div>

    <!-- Include JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Include epub.js -->
    <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.88/dist/epub.min.js"></script>
    <script>
        document.getElementById('convertButton').addEventListener('click', async () => {
            document.getElementById('nav').style.display='none';
            const fileInput = document.getElementById('fileInput');
            if (fileInput.files.length === 0) {
                alert('Please select an EPUB file.');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = async (e) => {
                const arrayBuffer = e.target.result;
                const book = ePub({ replacements: 'blobUrl' });

                await book.open(arrayBuffer);

                let jsonOutput = {
                    metadata: book.packaging.metadata,
                    chapters: []
                };

                let spineItems = book.spine.spineItems;
                var i=0;
                for (let item of spineItems) {
                    i=i+1;
                    let chapter = await item.load(book.load.bind(book));
                    let content = await item.render(); // Render the chapter to get its content

                    jsonOutput.chapters.push({
                        id: 'chapter_'+i,
                        href: item.href,
                        title: item.title,
                        content: content // Store the rendered content
                    });
                }
                    console.log(jsonOutput);
                    for (let c of jsonOutput.chapters){
                        if (c.id!=='cover' && c.id!=='chapter_0'){
                            document.getElementById('output').innerHTML += c.content.replace(/<html[\s\S]*?\<body>/g,'').replace(/<link [\s\S]*?\/>/g,'').replace('</body></html>','').replace('<h1 class="',`<h1 id="${c.id}" onclick="getContent('${c.id}_content')" class="tl `).replace('</h3><br',`</h3><div id="${c.id}_content" onclick="getContent('${c.id}_content')" style="display:none"><br`).replaceAll('<p>','<p class="tl">')+'</div><hr>';
                        }
                    }
                    document.querySelector('.ad_h1').remove();
                    document.querySelector('.ad_div').remove();
                    let ul=document.getElementsByClassName('sec_index_ul');
                    for (let l of ul){
                        l.style.display='none';
                        l.nextElementSibling.style.display='none';
                    }

                    var hAll=document.querySelectorAll('h1.tl');
                    for (let a of hAll){
                    if (a.innerText!==''){
                        var t=await translate(a.textContent);
                        a.innerHTML=a.innerHTML+'<br>'+t;
                    }
                }
            };

            reader.readAsArrayBuffer(file);
        });

        async function getContent(id){
            var el=document.getElementById(id);
            if (el.style.display=='none'){
                el.style.display='block';
                var all=el.querySelectorAll('.tl');
                for (let a of all){
                    if (a.innerText!==''){
                        var t=await translate(a.textContent);
                        a.innerHTML=a.innerHTML+'<br>'+t;
                    }
                }
            }else{el.style.display='none'}
        }

        async function translate(a){
        var url = 'https://translate.googleapis.com/translate_a/single?client=gtx&dt=t&sl=auto&tl=zh-TW&q='+encodeURIComponent(a);
        var res=await fetch(url);
        var raw=await res.json();
        var ts='';
        for (var j=0;j<raw[0].length;j++){
            ts=ts+raw[0][j][0];
        }
            return ts
        }

    </script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
</body>
</html>
</html>
